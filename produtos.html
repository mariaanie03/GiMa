<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes do Produto - Personalized Gift Shop</title>
    <link rel="stylesheet" href="css/pag-produtos.css">
</head>
<body>
    <header>
        <div class="logo"><img src="imagens/logomarca V3.png" alt="Logo Personalized Gift Shop"></div>
        <div class="site-name">Personalized Gift Shop</div>
        <div class="header-actions">
            <form id="search-form" action="resultados.html" method="GET">
                <input type="search" id="search-input" name="q" placeholder="Buscar..." required>
                <button type="submit" aria-label="Buscar">üîç</button>
            </form>
            <a href="carrinho.html" class="cart-icon" aria-label="Carrinho de Compras">
                üõí<span id="cart-count" style="background-color: red; color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.7em; vertical-align: top; display: none;">0</span>
            </a>
        </div>
    </header>

    <nav class="main-nav">
        <ul>
            <li><a href="index.html" class="nav-link">In√≠cio</a></li>
        </ul>
    </nav>

    <main>
        <div id="detalhe-produto-container">
            <div id="produto-imagem-container">
                <img id="produto-imagem" src="https://via.placeholder.com/400x400?text=Carregando..." alt="Imagem do produto">
            </div>
            <div id="produto-info-container">
                <h1 id="produto-nome">Carregando nome...</h1>
                <p id="produto-preco">R$ --,--</p>
                <p id="produto-descricao">Descri√ß√£o do produto aparecer√° aqui...</p>
                
                <button id="btn-add-carrinho" class="btn-produto-acao">Adicionar ao Carrinho</button>
                
                <a id="btn-personalizar" class="btn-produto-acao" href="metodos-personalizacao.html">Personalizar Produto</a>
            </div>
        </div>
    </main>

    <footer>
        <div class="footer-container">
            <div class="footer-column">
                <h4>Institucional</h4>
                <ul>
                    <li><a href="index.html?section=about">Sobre N√≥s</a></li>
                    <li><a href="termos.html">Termos e Condi√ß√µes</a></li>
                    <li><a href="privacidade.html">Pol√≠tica de Privacidade</a></li>
                </ul>
            </div>
            <div class="footer-column">
                <h4>Atendimento</h4>
                <ul>
                    <li><a href="mailto:contato@personalizedgiftshop.com.br">contato@personalizedgiftshop.com.br</a></li>
                    <li><a href="tel:+5511999999999">(11) 99999-9999</a></li>
                    <li>Seg. √† Sex. das 9h √†s 18h</li>
                </ul>
            </div>
            <div class="footer-column">
                <h4>Redes Sociais</h4>
                <div class="social-icons">
                    <a href="https://www.instagram.com/SEU_USUARIO_AQUI" target="_blank" rel="noopener noreferrer" aria-label="Instagram">IG</a>
                    <a href="https://www.facebook.com/SEU_USUARIO_AQUI" target="_blank" rel="noopener noreferrer" aria-label="Facebook">FB</a>
                    <a href="https://www.pinterest.com/SEU_USUARIO_AQUI" target="_blank" rel="noopener noreferrer" aria-label="Pinterest">PI</a>
                    <a href="https://www.tiktok.com/@SEU_USUARIO_AQUI" target="_blank" rel="noopener noreferrer" aria-label="Tik Tok">TK</a>
                    <a href="https://www.twitter.com/SEU_USUARIO_AQUI" target="_blank" rel="noopener noreferrer" aria-label="Twitter">X</a>
                </div>
            </div>
            <div class="footer-column">
                <h4>Newsletter</h4>
                <p>Receba novidades e promo√ß√µes!</p>
                <form id="newsletter-form">
                    <input type="email" placeholder="Seu e-mail" required>
                    <button type="submit">Assinar</button>
                </form>
            </div>
        </div>
        <div class="footer-bottom">
            <div class="payment-methods">
                <p>Formas de Pagamento:</p>
                <span>PIX</span> <span>VISA</span> <span>MASTERCARD</span> <span>ELO</span>
            </div>
            <div class="copyright">
                <p>¬© 2025 Personalized Gift Shop - Todos os direitos reservados.</p>
            </div>
        </div>
    </footer>


    <!-- 1. Carrega a conex√£o com o Supabase PRIMEIRO -->
    <script type="module" src="js/supabaseClient.js"></script>

    <!-- 2. Carrega o script principal que busca os detalhes do produto -->
    <script type="module" src="js/script.js"></script>

    <!-- 3. Carrega a l√≥gica de adicionar ao carrinho com prote√ß√£o de login -->
    <script type="module">
        // Importa o supabase para podermos verificar o login
        import { supabase } from './js/supabaseClient.js';

        document.addEventListener('DOMContentLoaded', () => {
            const btnAdicionar = document.getElementById('btn-add-carrinho');
            const urlParams = new URLSearchParams(window.location.search);
            const produtoId = urlParams.get('id');

            if (btnAdicionar && produtoId) {
                // Transformamos o evento de clique em uma fun√ß√£o 'async' para usar o supabase
                btnAdicionar.addEventListener('click', async () => {
                    
                    // 1. VERIFICAR SE O USU√ÅRIO EST√Å LOGADO
                    const { data: { session } } = await supabase.auth.getSession();

                    if (session) {
                        // --- USU√ÅRIO EST√Å LOGADO: L√ìGICA NORMAL ---
                        const carrinho = JSON.parse(localStorage.getItem('carrinho')) || [];
                        const personalizacao = localStorage.getItem('produtoPersonalizado');

                        const nomeProduto = document.getElementById('produto-nome').textContent;
                        const precoProdutoTexto = document.getElementById('produto-preco').textContent;

                        if (nomeProduto === 'Carregando nome...' || !precoProdutoTexto.includes('R$')) {
                            alert('Erro: Os detalhes do produto ainda n√£o foram carregados.');
                            return;
                        }

                        const produto = {
                            id: produtoId,
                            name: nomeProduto,
                            price: parseFloat(precoProdutoTexto.replace('R$ ', '').replace(',', '.')),
                            image: document.getElementById('produto-imagem').src,
                            quantity: 1,
                            customization: personalizacao || null
                        };

                        const itemExistente = carrinho.find(item => item.id === produto.id && item.customization === produto.customization);
                        if (itemExistente) {
                            itemExistente.quantity++;
                        } else {
                            carrinho.push(produto);
                        }

                        localStorage.setItem('carrinho', JSON.stringify(carrinho));
                        if (personalizacao) {
                            localStorage.removeItem('produtoPersonalizado');
                        }

                        alert(`"${produto.name}" foi adicionado ao carrinho!`);
                        atualizarContadorCarrinhoHeader();

                    } else {
                        // --- USU√ÅRIO N√ÉO EST√Å LOGADO: AVISO E REDIRECIONAMENTO ---
                        alert('Voc√™ precisa fazer login para adicionar produtos ao carrinho.');
                        window.location.href = 'index.html?section=login';
                    }
                });
            }
            
            const atualizarContadorCarrinhoHeader = () => {
                const carrinho = JSON.parse(localStorage.getItem('carrinho')) || [];
                const totalItens = carrinho.reduce((acc, item) => acc + item.quantity, 0);
                const contador = document.getElementById('cart-count');
                if(contador) {
                    contador.textContent = totalItens;
                    contador.style.display = totalItens > 0 ? 'inline' : 'none';
                }
            };
            
            atualizarContadorCarrinhoHeader();
        });
    </script>
</body>
</html>