<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes do Produto - Personalized Gift Shop</title>
    <link rel="stylesheet" href="css/pag-produtos.css">
</head>
<body>
    <header>
        <div class="logo"><img src="imagens/logomarca V3.png" alt="Logo Personalized Gift Shop"></div>
        <div class="site-name">Personalized Gift Shop</div>
        <div class="header-actions">
            <form id="search-form" action="resultados.html" method="GET">
                <input type="search" id="search-input" name="q" placeholder="Buscar..." required>
                <button type="submit" aria-label="Buscar">üîç</button>
            </form>
            <a href="carrinho.html" class="cart-icon" aria-label="Carrinho de Compras">
                üõí<span id="cart-count" style="background-color: red; color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.7em; vertical-align: top; display: none;">0</span>
            </a>
        </div>
    </header>

    <nav class="main-nav">
        <ul>
            <li><a href="index.html" class="nav-link">In√≠cio</a></li>
        </ul>
    </nav>

    <main>
        <div id="detalhe-produto-container">
            <div id="produto-imagem-container">
                <img id="produto-imagem" src="https://via.placeholder.com/400x400?text=Carregando..." alt="Imagem do produto">
            </div>
            <div id="produto-info-container">
                <h1 id="produto-nome">Carregando nome...</h1>
                <p id="produto-preco">R$ --,--</p>
                <p id="produto-descricao">Descri√ß√£o do produto aparecer√° aqui...</p>
                
                <button id="btn-add-carrinho" class="btn-produto-acao">Adicionar ao Carrinho</button>
                
                <a id="btn-personalizar" class="btn-produto-acao" href="metodos-personalizacao.html">Personalizar Produto</a>
            </div>
        </div>
    </main>

    <footer>
        <div class="footer-container">
            <div class="footer-column">
                <h4>Institucional</h4>
                <ul>
                    <li><a href="index.html?section=about">Sobre N√≥s</a></li>
                    <li><a href="termos.html">Termos e Condi√ß√µes</a></li>
                    <li><a href="privacidade.html">Pol√≠tica de Privacidade</a></li>
                </ul>
            </div>
            <div class="footer-column">
                <h4>Atendimento</h4>
                <ul>
                    <li><a href="mailto:contato@personalizedgiftshop.com.br">contato@personalizedgiftshop.com.br</a></li>
                    <li><a href="tel:+5511999999999">(11) 99999-9999</a></li>
                    <li>Seg. √† Sex. das 9h √†s 18h</li>
                </ul>
            </div>
            <div class="footer-column">
                <h4>Redes Sociais</h4>
                <div class="social-icons">
                    <a href="https://www.instagram.com/SEU_USUARIO_AQUI" target="_blank" rel="noopener noreferrer" aria-label="Instagram">IG</a>
                    <a href="https://www.facebook.com/SEU_USUARIO_AQUI" target="_blank" rel="noopener noreferrer" aria-label="Facebook">FB</a>
                    <a href="https://www.pinterest.com/SEU_USUARIO_AQUI" target="_blank" rel="noopener noreferrer" aria-label="Pinterest">PI</a>
                    <a href="https://www.tiktok.com/@SEU_USUARIO_AQUI" target="_blank" rel="noopener noreferrer" aria-label="Tik Tok">TK</a>
                    <a href="https://www.twitter.com/SEU_USUARIO_AQUI" target="_blank" rel="noopener noreferrer" aria-label="Twitter">X</a>
                </div>
            </div>
            <div class="footer-column">
                <h4>Newsletter</h4>
                <p>Receba novidades e promo√ß√µes!</p>
                <form id="newsletter-form">
                    <input type="email" placeholder="Seu e-mail" required>
                    <button type="submit">Assinar</button>
                </form>
            </div>
        </div>
        <div class="footer-bottom">
            <div class="payment-methods">
                <p>Formas de Pagamento:</p>
                <span>PIX</span> <span>VISA</span> <span>MASTERCARD</span> <span>ELO</span>
            </div>
            <div class="copyright">
                <p>¬© 2025 Personalized Gift Shop - Todos os direitos reservados.</p>
            </div>
        </div>
    </footer>


    <!-- 1. Carrega a conex√£o com o Supabase -->
    <script type="module" src="js/supabaseClient.js"></script>

    <!-- 2. Carrega o script principal que busca os detalhes do produto -->
    <script type="module" src="js/script.js"></script>

    <!-- 3. L√≥gica de adicionar ao carrinho com salvamento no BANCO DE DADOS -->
    <script type="module">
        import { supabase } from './js/supabaseClient.js';

        document.addEventListener('DOMContentLoaded', () => {
            const btnAdicionar = document.getElementById('btn-add-carrinho');
            const urlParams = new URLSearchParams(window.location.search);
            // Certifique-se de que o ID do produto √© um n√∫mero para corresponder ao banco de dados
            const produtoId = parseInt(urlParams.get('id'));

            if (btnAdicionar && produtoId) {
                btnAdicionar.addEventListener('click', async () => {
                    // Pega a sess√£o atual do usu√°rio
                    const { data: { session } } = await supabase.auth.getSession();

                    // Se n√£o houver sess√£o (usu√°rio n√£o logado), redireciona para o login
                    if (!session) {
                        alert('Voc√™ precisa fazer login para adicionar produtos ao carrinho.');
                        window.location.href = 'index.html?section=login';
                        return;
                    }

                    const userId = session.user.id;
                    // A personaliza√ß√£o ainda vem do localStorage, pois √© tempor√°ria
                    const personalizacao = localStorage.getItem('produtoPersonalizado');

                    try {
                        // 1. Verifica se um item id√™ntico (mesmo produto, mesmo usu√°rio) j√° existe no carrinho
                        const { data: itemExistente, error: selectError } = await supabase
                            .from('carrinhos')
                            .select('id, quantity') // Seleciona s√≥ o que precisamos
                            .eq('user_id', userId)
                            .eq('produto_id', produtoId)
                            .maybeSingle(); // Retorna um √∫nico item ou null, sem erro se n√£o encontrar

                        if (selectError) throw selectError;

                        if (itemExistente) {
                            // 2a. Se o item j√° existe, apenas incrementa a quantidade
                            const novaQuantidade = itemExistente.quantity + 1;
                            const { error: updateError } = await supabase
                                .from('carrinhos')
                                .update({ quantity: novaQuantidade })
                                .eq('id', itemExistente.id); // Atualiza usando a chave prim√°ria do item do carrinho
                            
                            if (updateError) throw updateError;
                        } else {
                            // 2b. Se o item n√£o existe, insere uma nova linha na tabela
                            const { error: insertError } = await supabase
                                .from('carrinhos')
                                .insert({
                                    user_id: userId,
                                    produto_id: produtoId,
                                    quantity: 1,
                                    customization: personalizacao // Salva a personaliza√ß√£o se houver
                                });

                            if (insertError) throw insertError;
                        }
                        
                        // Limpa a personaliza√ß√£o local do navegador ap√≥s salvar no banco
                        if (personalizacao) {
                            localStorage.removeItem('produtoPersonalizado');
                        }

                        alert(`"${document.getElementById('produto-nome').textContent}" foi adicionado ao carrinho!`);
                        
                        // Atualiza o contador do header
                        atualizarContadorCarrinhoHeader(userId);

                    } catch (error) {
                        console.error('Erro ao adicionar ao carrinho:', error);
                        alert('N√£o foi poss√≠vel adicionar o item ao carrinho. Tente novamente.');
                    }
                });
            }

            // Fun√ß√£o para atualizar o √≠cone do carrinho no header
            async function atualizarContadorCarrinhoHeader(userId) {
                const { data: { session } } = await supabase.auth.getSession();
                if (!session) return; // N√£o faz nada se n√£o estiver logado

                // Conta quantos itens o usu√°rio tem no carrinho no banco
                const { count, error } = await supabase
                    .from('carrinhos')
                    .select('*', { count: 'exact', head: true })
                    .eq('user_id', session.user.id);
                
                const contadorEl = document.getElementById('cart-count');
                if (contadorEl) {
                    const totalItens = count || 0;
                    contadorEl.textContent = totalItens;
                    contadorEl.style.display = totalItens > 0 ? 'inline-block' : 'none';
                }
            }

            // Carrega o contador assim que a p√°gina √© aberta
            atualizarContadorCarrinhoHeader();
        });
    </script>
</body>
</html>