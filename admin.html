<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Administração</title>
     <link rel="stylesheet" href="css/pag-admin.css">
    
</head>
<body>

    <div class="container">

        <section id="admin-login-section">
            <h1>Login do Administrador</h1>
            <form id="admin-login-form">
                <input type="email" id="admin-email" placeholder="E-mail" required>
                <input type="password" id="admin-password" placeholder="Senha" required>
                <button type="submit">Entrar</button>
            </form>
        </section>

        <section id="admin-panel-section">
            <button id="logout-btn" class="logout-btn">Sair</button>
            <h1>Painel de Administração</h1>
            
            <h2>Adicionar Novo Produto</h2>
            <form id="add-product-form">
                <input type="text" id="product-name" placeholder="Nome do Produto" required>
                <input type="number" step="0.01" id="product-price" placeholder="Preço (ex: 25.99)" required>
                <input type="text" id="product-description" placeholder="Descrição" required>
                <input type="text" id="product-category" placeholder="Categoria (ex: canecas, almofadas)" required>
                <label for="product-image">Imagem do Produto:</label>
                <input type="file" id="product-image" accept="image/*" required>
                <button type="submit">Adicionar Produto</button>
            </form>
            <p id="loading">Enviando... por favor, aguarde.</p>

            <h2>Produtos Atuais</h2>
            <div id="product-list">
            </div>
        </section>
    </div>

    <script type="module">
    import { supabase } from './js/supabaseClient.js';

    const ADMIN_EMAIL = 'luanakyo4@gmail.com'; 

    const loginSection = document.getElementById('admin-login-section');
    const panelSection = document.getElementById('admin-panel-section');
    const loadingIndicator = document.getElementById('loading');
    const loginForm = document.getElementById('admin-login-form');
    const logoutBtn = document.getElementById('logout-btn');
    const addProductForm = document.getElementById('add-product-form');
    const productListContainer = document.getElementById('product-list');

    const showLogin = () => {
        if (loginSection) loginSection.style.display = 'block';
        if (panelSection) panelSection.style.display = 'none';
    };

    const showAdminPanel = () => {
        if (loginSection) loginSection.style.display = 'none';
        if (panelSection) panelSection.style.display = 'block';
        fetchAndDisplayProducts();
    };

    if (loginForm) {
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;

            const { error } = await supabase.auth.signInWithPassword({ email, password });
            if (error) alert('Erro no login: ' + error.message);
        });
    }

    if (logoutBtn) {
        logoutBtn.addEventListener('click', async () => {
            await supabase.auth.signOut();
            window.location.href = 'index.html';
        });
    }

  
    supabase.auth.onAuthStateChange((event, session) => {
        if (session?.user && session.user.email === ADMIN_EMAIL) {
            showAdminPanel();
        } else {
            if (session?.user) {
                alert('Acesso negado. Apenas administradores podem acessar esta página.');
                supabase.auth.signOut();
            }
            showLogin();
        }
    });


    async function fetchAndDisplayProducts() {
        if (!productListContainer) return; 

        const { data: products, error } = await supabase.from('produtos').select('*');
        if (error) {
            console.error('Erro ao buscar produtos:', error);
            alert('Erro ao buscar produtos: ' + error.message);
            return;
        }

        productListContainer.innerHTML = '';
        products.forEach(product => {
            const productDiv = document.createElement('div');
            productDiv.className = 'product-list-item';
            productDiv.innerHTML = `
                <img src="${product.imagem_url}" alt="${product.nome}">
                <div class="info">
                    <strong>${product.nome}</strong> (${product.categoria})<br>
                    <span>R$ ${product.preco}</span>
                </div>
                <button class="delete-btn" data-id="${product.id_produtos}" data-path="${product.imagem_path}">Remover</button>
            `;
            productListContainer.appendChild(productDiv);
        });
    }


    if (addProductForm) {
        addProductForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const form = e.target;
            const nome = form['product-name'].value;
            const preco = form['product-price'].value;
            const descricao = form['product-description'].value;
            const categoria = form['product-category'].value;
            const imageFile = form['product-image'].files[0];

            if (!imageFile) {
                alert('Por favor, selecione uma imagem.');
                return;
            }

            if (loadingIndicator) loadingIndicator.style.display = 'block';

            const filePath = `public/${Date.now()}-${imageFile.name}`;
            const { error: uploadError } = await supabase.storage.from('imagens-produtos').upload(filePath, imageFile);

            if (uploadError) {
                alert('Erro ao enviar imagem: ' + uploadError.message);
                if (loadingIndicator) loadingIndicator.style.display = 'none';
                return;
            }

            const { data: publicUrlData } = supabase.storage.from('imagens-produtos').getPublicUrl(filePath);

            const { error: insertError } = await supabase.from('produtos').insert([{
                nome: nome,
                preco: preco,
                descricao: descricao,
                categoria: categoria.toLowerCase(),
                imagem_url: publicUrlData.publicUrl,
                imagem_path: filePath
            }]);

            if (loadingIndicator) loadingIndicator.style.display = 'none';
            if (insertError) {
                alert('Erro ao adicionar produto no banco de dados: ' + insertError.message);
            } else {
                alert('Produto adicionado com sucesso!');
                form.reset();
                fetchAndDisplayProducts();
            }
        });
    }


    if (productListContainer) {
        productListContainer.addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-btn')) {
                const productId = e.target.dataset.id;
                const imagePath = e.target.dataset.path;

                if (confirm('Tem certeza que deseja remover este produto? Esta ação não pode ser desfeita.')) {
                    const { error: dbError } = await supabase.from('produtos').delete().eq('id_produtos', productId);
                    
                    if (dbError) {
                        alert('Erro ao remover produto do banco de dados: ' + dbError.message);
                        return;
                    }

                    const { error: storageError } = await supabase.storage.from('imagens-produtos').remove([imagePath]);

                    if (storageError) {
                        alert('Produto removido do banco, mas falha ao remover a imagem: ' + storageError.message);
                    }
                    
                    alert('Produto removido com sucesso!');
                    fetchAndDisplayProducts();
                }
            }
        });
    }
</script>
</body>
</html>