<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meu Carrinho - Personalized Gift Shop</title>
    <link rel="stylesheet" href="css/pag-carrinho.css">
</head>
<body>
    <header>
        <div class="logo"><img src="imagens/logomarca V3.png" alt="Logo Personalized Gift Shop"></div>
        <div class="site-name">Personalized Gift Shop</div>
        <div class="header-actions">
            <form action="resultados.html" method="GET">
                <input type="search" name="q" placeholder="Buscar..." required>
                <button type="submit" aria-label="Buscar">üîç</button>
            </form>
            <a href="carrinho.html" class="cart-icon" aria-label="Carrinho de Compras">
                üõí<span id="cart-count">0</span>
            </a>
        </div>
    </header>

    <nav class="main-nav">
        <ul>
            <li><a href="index.html" class="nav-link">In√≠cio</a></li>
        </ul>
    </nav>

    <main>
        <!-- Container que s√≥ aparece se o usu√°rio estiver LOGADO -->
        <div id="carrinho-logado" style="display: none;">
            <h1>Meu Carrinho de Compras</h1>

            <!-- Container para o carrinho COM itens -->
            <div id="carrinho-cheio" class="carrinho-container">
                <div id="lista-produtos-carrinho" class="carrinho-produtos">
                    <!-- Produtos s√£o inseridos aqui pelo JavaScript -->
                </div>
                <div id="resumo-carrinho" class="carrinho-resumo">
                    <h2>Resumo do Pedido</h2>
                    <div class="resumo-linha">
                        <span>Subtotal:</span>
                        <span id="subtotal-valor">R$ 0,00</span>
                    </div>
                    <div class="resumo-linha">
                        <span>Frete:</span>
                        <span id="frete-valor">R$ 0,00</span>
                    </div>
                    <div id="resumo-total" class="resumo-linha">
                        <span>Total:</span>
                        <span id="total-valor">R$ 0,00</span>
                    </div>
                    <a href="#" class="btn-checkout">Finalizar Compra</a>
                </div>
            </div>

            <!-- Container para o carrinho VAZIO -->
            <div id="carrinho-vazio" style="display: none; text-align: center; padding: 50px;">
                <h2>Seu carrinho est√° vazio.</h2>
                <p>Adicione produtos para v√™-los aqui.</p>
                <a href="index.html" class="btn-continuar-comprando">Continuar Comprando</a>
            </div>
        </div>

        <!-- Container que s√≥ aparece se o usu√°rio N√ÉO ESTIVER LOGADO -->
        <div id="carrinho-deslogado" style="display: none; text-align: center; padding: 50px;">
            <h2>Voc√™ precisa estar logado para ver seu carrinho.</h2>
            <p>Fa√ßa o login ou crie sua conta para continuar suas compras.</p>
            <a href="index.html?section=login" class="btn-continuar-comprando">Ir para o Login</a>
        </div>
    </main>

    <footer>
        <div class="footer-container">
            <div class="footer-column">
                <h4>Institucional</h4>
                <ul>
                    <li><a href="index.html?section=about">Sobre N√≥s</a></li>
                    <li><a href="termos.html">Termos e Condi√ß√µes</a></li>
                    <li><a href="privacidade.html">Pol√≠tica de Privacidade</a></li>
                </ul>
            </div>
            <div class="footer-column">
                <h4>Atendimento</h4>
                <ul>
                    <li><a href="mailto:contato@personalizedgiftshop.com.br">contato@personalizedgiftshop.com.br</a></li>
                    <li><a href="tel:+5511999999999">(11) 99999-9999</a></li>
                    <li>Seg. √† Sex. das 9h √†s 18h</li>
                </ul>
            </div>
            <div class="footer-column">
                <h4>Redes Sociais</h4>
                <div class="social-icons">
                    <a href="https://www.instagram.com/SEU_USUARIO_AQUI" target="_blank" rel="noopener noreferrer" aria-label="Instagram">IG</a>
                    <a href="https://www.facebook.com/SEU_USUARIO_AQUI" target="_blank" rel="noopener noreferrer" aria-label="Facebook">FB</a>
                    <a href="https://www.pinterest.com/SEU_USUARIO_AQUI" target="_blank" rel="noopener noreferrer" aria-label="Pinterest">PI</a>
                    <a href="https://www.tiktok.com/@SEU_USUARIO_AQUI" target="_blank" rel="noopener noreferrer" aria-label="Tik Tok">TK</a>
                    <a href="https://www.twitter.com/SEU_USUARIO_AQUI" target="_blank" rel="noopener noreferrer" aria-label="Twitter">X</a>
                </div>
            </div>
            <div class="footer-column">
                <h4>Newsletter</h4>
                <p>Receba novidades e promo√ß√µes!</p>
                <form id="newsletter-form">
                    <input type="email" placeholder="Seu e-mail" required>
                    <button type="submit">Assinar</button>
                </form>
            </div>
        </div>
        <div class="footer-bottom">
            <div class="payment-methods">
                <p>Formas de Pagamento:</p>
                <span>PIX</span> <span>VISA</span> <span>MASTERCARD</span> <span>ELO</span>
            </div>
            <div class="copyright">
                <p>¬© 2025 Personalized Gift Shop - Todos os direitos reservados.</p>
            </div>
        </div>
    </footer>
    
    <!-- Carrega o supabase primeiro -->
    <script type="module" src="js/supabaseClient.js"></script>

    <!-- Script da p√°gina do carrinho com prote√ß√£o de login -->
    <script type="module">
        import { supabase } from './js/supabaseClient.js';

        document.addEventListener('DOMContentLoaded', async () => {
            // 1. VERIFICA O STATUS DE LOGIN ASSIM QUE A P√ÅGINA CARREGA
            const { data: { session } } = await supabase.auth.getSession();

            const carrinhoLogadoDiv = document.getElementById('carrinho-logado');
            const carrinhoDeslogadoDiv = document.getElementById('carrinho-deslogado');

            if (session) {
                // --- USU√ÅRIO EST√Å LOGADO ---
                carrinhoLogadoDiv.style.display = 'block';
                carrinhoDeslogadoDiv.style.display = 'none';
                
                // Executa a l√≥gica normal de renderiza√ß√£o do carrinho
                iniciarLogicaCarrinho();
            } else {
                // --- USU√ÅRIO N√ÉO EST√Å LOGADO ---
                carrinhoLogadoDiv.style.display = 'none';
                carrinhoDeslogadoDiv.style.display = 'block';
                // Limpa o carrinho local para n√£o vazar informa√ß√µes se outro usu√°rio logar
                localStorage.removeItem('carrinho');
                atualizarContadorCarrinhoHeader(); // Garante que o contador do header zere
            }
        });
        
        // Fun√ß√£o para atualizar o contador no header (pode ser chamada de v√°rios lugares)
        const atualizarContadorCarrinhoHeader = () => {
            const carrinho = JSON.parse(localStorage.getItem('carrinho')) || [];
            const totalItens = carrinho.reduce((acc, item) => acc + item.quantity, 0);
            const contador = document.getElementById('cart-count');
            if(contador) {
                contador.textContent = totalItens;
                contador.style.display = totalItens > 0 ? 'inline' : 'none';
            }
        };

        // Toda a l√≥gica de manipula√ß√£o do carrinho agora est√° dentro desta fun√ß√£o
        function iniciarLogicaCarrinho() {
            const listaProdutosContainer = document.getElementById('lista-produtos-carrinho');
            const carrinhoCheioContainer = document.getElementById('carrinho-cheio');
            const carrinhoVazioContainer = document.getElementById('carrinho-vazio');
            
            const getCarrinho = () => JSON.parse(localStorage.getItem('carrinho')) || [];
            const salvarCarrinho = (carrinho) => localStorage.setItem('carrinho', JSON.stringify(carrinho));

            const renderizarCarrinho = () => {
                const carrinho = getCarrinho();
                listaProdutosContainer.innerHTML = '';

                if (carrinho.length === 0) {
                    carrinhoCheioContainer.style.display = 'none';
                    carrinhoVazioContainer.style.display = 'block';
                } else {
                    carrinhoCheioContainer.style.display = 'flex';
                    carrinhoVazioContainer.style.display = 'none';
                    carrinho.forEach(item => {
                        const produtoHTML = `
                            <div class="produto-carrinho" data-id="${item.id}" data-custom="${item.customization || ''}">
                                <img src="${item.customization || item.image}" alt="${item.name}">
                                <div class="produto-info">
                                    <h3>${item.name}</h3>
                                    <p>Pre√ßo: R$ ${parseFloat(item.price).toFixed(2)}</p>
                                </div>
                                <div class="produto-qtd">
                                    <button class="btn-diminuir-qtd">-</button>
                                    <span>${item.quantity}</span>
                                    <button class="btn-aumentar-qtd">+</button>
                                </div>
                                <div class="produto-remover">
                                    <button class="btn-remover-item">üóëÔ∏è</button>
                                </div>
                            </div>
                        `;
                        listaProdutosContainer.innerHTML += produtoHTML;
                    });
                }
                atualizarResumo();
                atualizarContadorCarrinhoHeader();
            };

            const atualizarResumo = () => {
                const carrinho = getCarrinho();
                const subtotal = carrinho.reduce((acc, item) => acc + (item.price * item.quantity), 0);
                const frete = carrinho.length > 0 ? 15.00 : 0; // Frete s√≥ √© cobrado se houver itens
                const total = subtotal + frete;

                document.getElementById('subtotal-valor').textContent = `R$ ${subtotal.toFixed(2)}`;
                document.getElementById('frete-valor').textContent = `R$ ${frete.toFixed(2)}`;
                document.getElementById('total-valor').textContent = `R$ ${total.toFixed(2)}`;
            };

            listaProdutosContainer.addEventListener('click', (e) => {
                const produtoDiv = e.target.closest('.produto-carrinho');
                if (!produtoDiv) return;

                const produtoId = produtoDiv.dataset.id;
                const customizacao = produtoDiv.dataset.custom;
                
                let carrinho = getCarrinho();
                const itemIndex = carrinho.findIndex(item => item.id === produtoId && (item.customization || '') === customizacao);
                if (itemIndex === -1) return;

                if (e.target.classList.contains('btn-aumentar-qtd')) {
                    carrinho[itemIndex].quantity++;
                } else if (e.target.classList.contains('btn-diminuir-qtd')) {
                    carrinho[itemIndex].quantity--;
                    if (carrinho[itemIndex].quantity <= 0) {
                        carrinho.splice(itemIndex, 1);
                    }
                } else if (e.target.classList.contains('btn-remover-item')) {
                    carrinho.splice(itemIndex, 1);
                }
                
                salvarCarrinho(carrinho);
                renderizarCarrinho();
            });
            
            // Primeira renderiza√ß√£o ao iniciar a l√≥gica
            renderizarCarrinho();
        }
    </script>
</body>
</html>